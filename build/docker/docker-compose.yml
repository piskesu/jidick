services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:${ELASTIC_VERSION:-8.15.5}
    container_name: elasticsearch
    network_mode: host
    environment:
      discovery.type: single-node
      ELASTIC_PASSWORD: ${ELASTIC_PASSWORD:-}
      KIBANA_SYSTEM_PASSWORD: ${KIBANA_SYSTEM_PASSWORD:-}
    volumes:
      - ./elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro
      - ./elasticsearch-jvm.options:/usr/share/elasticsearch/config/jvm.options:ro
  
  prometheus:
    image: prom/prometheus:${PROMETHEUS_VERSION:-v2.53.3}
    container_name: prometheus
    network_mode: host
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro

  grafana:
    image: grafana/grafana-oss:${GRAFANA_VERSION:-12.0.3}
    container_name: grafana
    network_mode: host
    volumes:
      - ./grafana/datasources/elasticsearch.yaml:/etc/grafana/provisioning/datasources/elasticsearch.yaml:ro
      - ./grafana/datasources/prometheus.yaml:/etc/grafana/provisioning/datasources/prometheus.yaml:ro
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
    depends_on:
      - prometheus
      - elasticsearch

  huatuo-bamai:
    image: huatuo/huatuo-bamai:latest
    container_name: huatuo-bamai
    network_mode: host
    cgroup: host
    privileged: true
    environment:
      ELASTICSEARCH_HOST: ${ELASTICSEARCH_HOST:-}
      ELASTIC_PASSWORD: ${ELASTIC_PASSWORD:-}
      RUN_PATH: ${RUN_PATH:-}
    volumes:
      - /sys:/sys:rw
      - /proc:/proc:rw
      - /run:/run:rw
      - /etc:/etc:ro
      - /var:/var:ro
      - ../../huatuo-bamai.conf:${RUN_PATH}/huatuo-bamai.conf:rw
      - ./run.sh:${RUN_PATH}/run.sh:ro
    command: ["./run.sh"]
    depends_on:
      - elasticsearch
      - prometheus
      - grafana
